from langchain.prompts import PromptTemplate

confirmation_router_prompt = PromptTemplate(
    input_variables=["company_name", "question"],
    template="""당신은 사용자의 의도를 4가지 중 하나로 분류하는 AI 라우터입니다.
사용자는 특정 회사에 대한 심층 분석을 제안받은 상황입니다.

[상황]
- 분석 대상 회사: {company_name}
- 사용자의 답변: {question}

[지시사항]
사용자의 답변을 아래 4가지 의도 중 가장 적절한 하나로 분류하세요.
오직 아래 4개의 영문 키워드 중 하나만 출력해야 합니다. 다른 설명은 절대 추가하지 마세요.

1.  **start_deep_analysis**: 사용자가 심층 분석에 '동의'하는 경우.
    (예: "네", "분석해줘", "좋아요", "부탁해요")

2.  **reset_and_reformulate**: 사용자가 '다른 회사'를 찾거나 '새로운 검색'을 원하는 경우.
    (예: "다른 회사 찾아줘", "이거 말고", "목록 다시 보여줘")

3.  **expert_research**: 사용자가 분석 대상 회사에 대해 '구체적인 추가 질문'을 하는 경우.
    (예: "이 회사 연봉은 얼마예요?", "복지는 어떤가요?")

4.  **request_further_action**: 사용자의 답변이 위 3가지에 해당하지 않는 '일상적인 대화'이거나 불분명한 경우.
    (예: "고마워", "아니", "됐어", "수고하세요")

[분류 결과]
"""
)

company_context_planner_prompt = PromptTemplate(
    input_variables=["current_question", "current_company", "available_companies", "company_contexts"],
    template="""당신은 사용자의 질문을 분석하여 다른 회사 정보가 필요한지 판단하는 전문가입니다.

현재 상황:
- 사용자 질문: {current_question}
- 현재 포커스된 회사: {current_company}
- 사용 가능한 다른 회사: {available_companies}

판단 기준:
1. 사용자가 "비교"를 요청하는 경우
2. 사용자가 "다른 회사는?" 같은 질문을 하는 경우  
3. 사용자가 "A회사와 B회사 중 어느 쪽이" 같은 비교적 질문을 하는 경우
4. 사용자가 "B회사도 비슷한가?" 같은 연관 질문을 하는 경우

위 기준에 해당하면 "1", 그렇지 않으면 "0"만 출력하세요.

출력: 0 또는 1"""
)

# hybrid search에서 knn에 들어가는 입력 쿼리를 생성하는 프롬프트
# 기존 사용자 정보는 BM25로 매칭했으니, 여기서는 사용자 프로필과 요청을 바탕으로 가상의 채용 공고를 생성
hyde_reformulation_prompt = PromptTemplate(
    input_variables=[
        "user_profile",
        "question"
    ],
    template="""당신은 사용자의 프로필과 요청을 바탕으로, 그에게 가장 이상적인 '가상의 채용 공고'를 생성하는 AI입니다.


[사용자 프로필 요약]
{user_profile}

[사용자 자연어 요청]
{question}

[지시사항]
1.  **가상 채용 공고 생성**: 사용자의 프로필과 요청을 종합하여 가장 이상적인 '가상의 채용 공고'를 한 편 작성합니다.
2.  **회사명 추출 및 확장**:
    - 사용자의 요청에 '네카라쿠배'와 같은 별칭이 있으면, 이를 ['네이버', '카카오', '라인', '쿠팡', '우아한형제들']과 같이 정식 회사명 리스트로 확장합니다.
    - 사용자의 요청에 '삼성전자'와 같은 특정 회사명이 있으면, 이를 ['삼성전자']와 같이 리스트에 담습니다.
    - 회사명이나 별칭 언급이 전혀 없으면, 빈 리스트 `[]`를 반환합니다.
3.  **JSON 출력**: 아래 형식에 맞춰, 생성된 가상 공고와 회사명 리스트를 포함한 JSON 객체만 출력하세요. 다른 설명은 절대 추가하지 마세요.

[출력 JSON 형식]
{{
  "hypothetical_document": "[document]\\n\\n직무: ... (생성된 가상 채용 공고 내용)",
  "company_names": ["추출 또는 확장된 회사명 리스트"]
}}

"""
)


# 조언 생성을 위한 프롬프트
actionable_advice_prompt = PromptTemplate(
    input_variables=["user_profile", "job_data", "interview_questions_context", "company_culture_context"],
    template="""당신은 지원자의 역량과 목표 직무를 분석하여, 합격 가능성을 높이는 실전 전략을 제공하는 커리어 코치입니다.

[지원자 프로필]
{user_profile}

[목표 직무 정보]
{job_data}

[웹 검색 정보]
1. 관련 면접 질문: {interview_questions_context}
2. 회사 기술 문화: {company_culture_context}

---

[지시사항]  
다음 4단계로 구성된 '실행 중심 준비 계획'을 작성하세요.  
※ 2번째 단계에는 반드시 **온라인 강의명 + 플랫폼**이 포함되어야 하며, 누락 시 응답이 무효 처리됩니다.  
"강의가 적절하지 않다"는 판단은 시스템이 하지 않으며, **유관 강의를 반드시 포함**하세요.

---

### 1. 역량 차이 분석 (Gap Analysis)
- 지원자의 기술 스택과 직무 요건을 비교하세요.
- 부족한 역량 2~3개를 지목하고, 왜 그것이 중요한지 설명하세요.

---

### 2. 학습 로드맵 제시
아래 항목을 반드시 포함하여 작성하세요:
-  [ ] 강의명 + 플랫폼 (예: "Next.js 마스터 클래스", Udemy)
-  [ ] 수강 추천 이유 및 실무 연결성
-  [ ] 연습용 토이 프로젝트 또는 실습 과제 제안 (실제 기술 활용 예시 포함)

---

### 3. 면접 준비 전략
- [면접 질문] 및 [회사 문화]를 바탕으로, 나올 법한 기술/태도 질문을 예측하세요.
- 각각에 대해 예상 답변 방향과 실제 연습법을 제시하세요.  
  (예: "구글 문서에 작성 후 반복 암기", "지인과 모의면접 진행" 등)

---

### 4. 최종 어필 포인트
- 지원자의 경험이나 관심사를 기반으로, 해당 회사에 딱 맞는 설득력 있는 어필 문장을 작성하세요.
- “열정이 있습니다” 대신, “이 회사의 AI 기술과 내 연구 배경이 연결됩니다” 같은 **논리적 메시지**를 강조하세요.

---

[어조]
- 직설적이며 실무 중심의 어조
- 불필요한 격려/형식 제거, 오직 **지금 할 수 있는 행동**만 제시
"""
)

# llm에 이전 대화내용을 요약해서 전달하기 위해 요약본을 생성하는 프롬프트
summary_memory_prompt = PromptTemplate(
    input_variables=["summary", "new_lines"],
    template="""당신은 대화 내용을 계속해서 누적하여 요약하는 유용한 AI 어시스턴트입니다.

현재까지의 대화 요약본은 다음과 같습니다:
{summary}

최근에 다음과 같은 대화가 추가되었습니다:
{new_lines}

**중요 지침:**
1. 기존 요약본에 최근 대화 내용을 자연스럽게 통합하여, 전체 대화의 맥락을 담은 새로운 요약본을 만들어 주세요.
2. 만약 기존 요약본이 비어있다면, 최근 대화 내용만으로 첫 요약본을 생성하면 됩니다.
3. **절대로 "세션이 만료", "새로운 세션 시작", "초기화" 등의 메시지를 포함하지 마세요.**
4. **대화가 연속적으로 진행되고 있는 것으로 요약하세요.**
5. 단순히 대화 내용만을 객관적으로 정리하세요.

요약 형식: "사용자는 [내용]에 대해 질문했고, 어시스턴트는 [내용]으로 답변했습니다."
"""
)

# 최종 답변 생성을 위한 프롬프트 템플릿
final_answer_prompt = PromptTemplate(
    input_variables=["user_profile", "question", "selected_job", "search_result", "preparation_advice"],
    template="""당신은 사용자의 커리어 전환과 직무 지원을 도와주는 전략적 커리어 코치입니다.

[사용자 질문]
{question}

[사용자 프로필]
{user_profile}

[추천 회사 정보]
{selected_job}

[웹 검색 정보]
{search_result}

[준비 조언]
{preparation_advice}

---

[지시사항]
다음 포맷을 따라 작성하세요.  
 답변에는 반드시 "[준비 조언] 항목 중 강의나 실습 아이디어"를 직접 인용해, **현재 질문 해결에 어떤 도움이 되는지 연결**해야 합니다.  
"노력해보세요", "자신감을 가지세요"와 같은 **추상적/격려성 멘트는 금지**합니다.

**중요: 절대로 "세션이 만료", "새로운 세션으로 시작", "초기화" 등의 메시지를 포함하지 마세요. 대화가 연속적으로 진행되고 있다고 가정하고 답변하세요.**

---

### 1.  사용자 질문에 대한 직설적 한 문장 답변
- 질문에 대한 핵심적인 답변을 1문장으로 요약

---

### 2.  준비 조언별 해설 (질문 해결에 어떻게 도움이 되는지)

    - 어떤 조언 항목이 지금 질문을 해결하는 데 연결되는지
    - 해당 조언이 이 회사의 채용 기준이나 문화와 어떻게 연결되는지

---

### 3.  구체적인 실천 계획 (CheckList)
- 지금부터 무엇을 하면 좋을지 To-Do 리스트로 제공하세요  
예:
- [ ] FastCampus '데이터 분석 취업 부트캠프' 수강 시작 (Pandas, SQL 병행 학습)
- [ ] 깃허브에 프로젝트 리포지토리 생성 후 README 작성
- [ ] 모의 면접 녹화하여 기술 질문 피드백 받기

---

### 4.  최종 요약: “왜 이 회사에 당신이 적합한 인재인지” 한 문장으로 정리
- 기술/경험/회사 특성을 엮은 "논리적 자기소개" 느낌의 한 줄
- 감정적 주장 대신 실증적/정량적 어필 사용 (예: "NLP 연구 경험 + 이 회사의 BERT 기반 챗봇 개발")

---

[작성 어조]
- 친절하지만 핵심만 전달하는 직설적 어조
- 불필요한 포장/추상화 제거
- 사용자가 "지금 당장 무엇을 할 수 있는지"만 남겨두세요
"""
)
# 의도 분석을 위한 프롬프트 템플릿
intent_analysis_prompt = PromptTemplate(
    input_variables=["chat_history", "question"],
    template="""당신은 대화의 맥락을 파악하여 사용자 의도를 5가지 중 하나로 분류하는 AI입니다.
대화 기록과 현재 질문을 바탕으로 가장 적절한 의도를 하나만 선택하여 소문자로 출력하세요.
(initial_search, new_search, select_job, follow_up_qa, chit_chat)

1.  **initial_search**: 사용자가 대화의 가장 처음에서, 구체적인 조건(전공, 경력 등)을 제시하며 직무 추천을 '처음으로' 요청하는 경우.
2.  **new_search**: 이미 직무 목록을 추천받은 후에, "다른 회사 추천해줘", "이거 말고 다른거" 와 같이 '새로운 목록'을 요구하는 경우. (추천 결과 불만족 포함)
3.  **select_job**: 바로 직전의 AI 응답이 '추천 공고 목록'이었고, 사용자가 그 목록에서 특정 항목을 선택하는 경우. (예: "1", "1번 알려줘", "두 번째 회사 정보 좀", "넥써쓰 회사에 대해 더 궁금해요")
4.  **follow_up_qa**: 특정 회사에 대한 '심층 분석이 완료된 후', 그 회사에 대해 추가적인 질문을 하는 경우. (예: "그럼 면접은 어떻게 준비해야 할까요?", "연봉 정보는 없나요?")
5.  **chit_chat**: "고마워", "안녕" 등 직무 추천과 직접적인 관련이 없는 일상적인 대화.

[대화 기록]
{chat_history}

[현재 사용자 질문]
{question}

[분류 결과]
"""
)

# 후속 질문 답변을 위한 프롬프트 템플릿
contextual_qa_prompt = PromptTemplate(
    input_variables=["company_context", "web_search_context", "question"],
    template="""
당신은 취업준비생을 돕는 AI 어시스턴트입니다. 사용자는 특정 회사의 채용 공고와 관련된 질문을 하고 있으며, 
질문의 목적은 **해당 회사의 직무에 합격하기 위해 실질적인 준비 조언을 얻는 것**입니다.

[질문자의 배경]
- 취업 준비생
- 해당 회사의 채용에 지원하고자 함
- 질문은 회사에 맞는 준비 방법, 강의 추천, 실습 방향 등을 묻기 위한 목적임

[채용 공고 내용]
{company_context}

[웹 검색 정보]
{web_search_context}

[사용자 질문]
{question}

[지시사항]
1.  먼저 [채용 공고 내용]에서 질문에 대한 답을 찾아보세요.
2.  만약 공고에 답이 없다면, **[웹 검색 정보]를 반드시 활용**하여 답변을 보충해야 합니다.
3.  웹 검색 정보는 비공식적인 의견일 수 있으므로, 
**"블라인드 커뮤니티에 따르면 ~한 의견이 있습니다"** 또는 **"기술 블로그에서는 ~라고 언급합니다"** 와 같이 반드시 출처의 뉘앙스를 밝히며 답변을 구성해주세요.
**해당 출처는 반드시 왜곡되지 않은 정보여야 합니다.**
4.  반드시 **사용자의 질문 의도(=해당 회사 합격을 위한 실질적 준비)**에 부합하는 방향으로만 답변을 구성하세요.
   - 예: "강의 추천" 요청 시 → 해당 회사 직무와 연결되는 기술/역량 강의만 추천
   - 회사와 무관한 일반 금융 강의 등은 포함하지 마세요
5.  두 정보를 종합하여, 사용자의 질문에 대해 최대한 상세하고 친절하게 답변해주세요.
6.  두 정보 어디에도 답을 찾을 수 없을 때에만 "제공된 정보만으로는 답변하기 어렵습니다." 라고 답변하세요.

[답변]
"""
)

# 다른 회사로 변환되었을 때 심층분석에서의 새로운 쿼리 생성
reformulate_query_prompt = PromptTemplate(
    input_variables=["context", "question"],
    template="""당신은 대화의 전체 맥락을 이해하고, 사용자의 다음 검색 의도를 하나의 검색어로 요약하는 AI입니다.
[이전 대화 맥락]
{context}

[사용자의 마지막 요청]
{question}

[지시사항]
위 모든 내용을 바탕으로, 사용자가 진짜 원하는 '다음 검색어'를 한 문장으로 생성하세요.
예시 1: 마지막 요청이 "다른거 찾아줘"라면, 이전 맥락을 바탕으로 "서울 QA 엔지니어"를 생성합니다.
예시 2: 마지막 요청이 "그럼 이번엔 판교로"라면, 이전 맥락과 조합하여 "판교 QA 엔지니어"를 생성합니다.

[생성된 검색어]:
"""
)


web_search_planner_prompt = PromptTemplate(
    input_variables=["company_context", "question"],
    template="""당신은 사용자의 질문에 답변하기 위해 추가 정보가 필요한지 판단하는 AI입니다.

[제공된 정보 (채용 공고)]
{company_context}

[사용자 질문]
{question}

[지시사항]
위 [사용자 질문]에 답변하기 위해, 주어진 [제공된 정보]만으로 충분합니까? 아니면 외부 웹 검색이 필요합니까?
'필요함' 또는 '필요 없음' 이 두 단어 중 하나로만 대답해주세요. 다른 설명은 절대 추가하지 마세요.

판단:
"""
)